name: Build and Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-deploy-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v3

      - name: install dependencies
        uses: borales/actions-yarn@v4
        with:
          dir: web
          cmd: install

      - name: build app
        working-directory: web
        run: yarn build

      - name: deploy app
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: web/build

  build-and-deploy-api:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v3

      - name: login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: login to registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: build and push to registry
        working-directory: api
        run: |
          docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/prod:${{ github.sha }}
          docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/prod:${{ github.sha }}

      - name: deploy image to api
        uses: azure/webapps-deploy@v2
        with:
          app-name: urls-prod-api
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          images: "${{ secrets.REGISTRY_LOGIN_SERVER }}/prod:${{ github.sha }}"
